<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOP & Tools Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      // Dark Mode configuration applied only to elements with 'dark:' prefix
      darkMode: 'class',
      theme: {
        extend: {
          // Use Roboto as the primary font
          fontFamily: {
            sans: ['Roboto', 'sans-serif'],
          },
          colors: {
            // Google-inspired colors
            'google-blue': '#4285F4',
            'google-green': '#34A853',
            'google-red': '#EA4335',
            'google-yellow': '#FBBC05',
            // Coaching Log/IR NTE colors
            'brand-accent': '#CBEB33', // Matches original SOP 'brand'
            'brand-dark': '#B5D12F',
            // Custom dark mode palette for isolated dark elements
            'bg-dark': '#0f172a', // Main dark background
            'text-dark': '#f1f5f9', // Light text on dark backgrounds
            'card-dark': '#1e293b', // Card/Header dark background
            'border-dark': '#334155', // Dark border/secondary background
            'danger': '#ef4444',
            'danger-dark': '#dc2626',
            'bg-light': '#f8fafc', // Standard light background
            'text-light': '#1e293b', // Standard dark text
          }
        }
      }
    }
  </script>
  <style>
    /* Custom styles for Drawer and active tab indicator */
    .drawer {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      transform: translateX(-100%);
    }
    .drawer-open {
      transform: translateX(0);
    }
    .tab-active {
      background-color: theme('colors.blue.50'); 
      color: theme('colors.google-blue');
      font-weight: 500;
      border-radius: 9999px; 
    }
    .tab-active .material-symbols-outlined {
      color: theme('colors.google-blue');
    }
    /* Hover state for nav items */
    .nav-item:hover {
      background-color: theme('colors.gray.100');
      border-radius: 9999px;
    }
    /* SOP/Tools Table Header: Use a deep slate color for strong contrast */
    .table-header-dark {
        background-color: theme('colors.slate.900');
    }
    /* SOP/Tools Loading Spinner animation */
    .animate-spin-slow {
        animation: spin 2.5s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Modal Transition Classes */
    .modal {
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
    }
    .opacity-0 {
        opacity: 0;
    }
    .scale-95 {
        transform: scale(0.95);
    }
    .opacity-100 {
        opacity: 1;
    }
    .scale-100 {
        transform: scale(1);
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 font-sans transition-colors duration-500 dark:bg-bg-dark dark:text-text-dark">

  <aside id="drawer" class="drawer fixed top-0 left-0 h-full w-64 bg-white shadow-2xl z-50 dark:bg-card-dark dark:text-text-dark">
    <div class="flex items-center gap-2 p-4 pt-5 border-b sticky top-0 bg-white dark:bg-card-dark dark:border-border-dark z-10">
  <!-- Logo -->
  <img src="dmi_logo.png" alt="Digital Minds BPO Logo"
    class="h-10 object-contain" />
      <button id="closeDrawer" class="ml-auto text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-text-dark p-2 rounded-full hover:bg-gray-100 dark:hover:bg-border-dark">
        <span class="material-symbols-outlined text-2xl">close</span>
      </button>
    </div>

    <nav class="p-3 text-sm font-normal text-gray-700 dark:text-gray-300">
      <ul class="space-y-1">
        <li>
          <button class="nav-item flex items-center gap-3 p-3 w-full text-left transition duration-150 ease-in-out dark:hover:bg-border-dark" data-tab-title="SOP Documents" onclick="showTab('sop', event)">
            <span class="material-symbols-outlined text-xl">menu_book</span>
            <span>SOP Documents</span>
          </button>
        </li>
        <li>
          <button class="nav-item flex items-center gap-3 p-3 w-full text-left transition duration-150 ease-in-out dark:hover:bg-border-dark" data-tab-title="Tools List" onclick="showTab('tools', event)">
            <span class="material-symbols-outlined text-xl">build</span>
            <span>Tools List</span>
          </button>
        </li>
      </ul>
    </nav>
  </aside>


  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40 transition-opacity duration-300"></div>

  <div id="page-content">
    <header class="flex items-center gap-4 bg-white dark:bg-card-dark p-4 shadow-md sticky top-0 z-30 transition-colors duration-500 border-b border-gray-100 dark:border-border-dark">
      <button id="menuBtn" class="text-gray-600 dark:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-border-dark transition">
        <span class="material-symbols-outlined text-2xl">menu</span>
      </button>
      <h1 id="mainTitleContainer" class="text-2xl font-extrabold text-gray-900 dark:text-text-dark"></h1>
      <button id="themeToggle"
            class="ml-auto p-2 rounded-full text-gray-800 dark:text-text-dark bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-300 transform hover:scale-105"
            aria-label="Toggle Dark Mode">
        </button>
    </header>

    <main class="max-w-7xl mx-auto p-6 lg:p-10 space-y-12">


<!-- === SOP DOCUMENTS SECTION === -->
<div id="sop" class="tab-content hidden">
  <!-- Search + Add New -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0 mt-2">
    <div class="relative w-full md:w-1/3">
      <input type="text" id="sopSearch" onkeyup="handleSOPSearch()"
        placeholder="Search by document name, campaign, or description..."
        class="w-full p-3 pl-10 border border-gray-300 rounded-full focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-card-dark dark:border-border-dark dark:text-text-dark transition shadow-md">
      <span
        class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl">search</span>
    </div>

    <button id="newSOPBtn"
      class="inline-flex items-center bg-brand-accent hover:bg-brand-dark text-bg-dark px-6 py-3 rounded-full shadow-lg font-bold transition duration-300 transform hover:scale-[1.03] text-lg">
      <i class="fas fa-file-alt mr-3"></i>New SOP Entry
    </button>
  </div>

  <!-- Table Container -->
  <div
    class="relative mt-6 bg-white dark:bg-card-dark rounded-2xl shadow-2xl shadow-gray-200/50 dark:shadow-xl dark:shadow-black/50 overflow-hidden transition-colors duration-500 border border-gray-100 dark:border-border-dark">

    <!-- Loading Spinner -->
    <div id="sopLoadingSpinner"
      class="hidden absolute inset-0 bg-white/90 dark:bg-card-dark/90 backdrop-blur-sm flex justify-center items-center z-40 transition-opacity duration-300">
      <div class="flex flex-col items-center">
        <i class="fas fa-sync-alt fa-3x text-brand-accent animate-spin-slow"></i>
        <p id="sopLoadingText" class="mt-3 text-lg text-gray-700 dark:text-text-dark font-medium">Loading SOP data...</p>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900 dark:bg-border-dark text-white dark:text-text-dark uppercase tracking-wider">
          <tr>
            <th class="px-6 py-4 text-left font-semibold">ID</th>
            <th class="px-6 py-4 text-left font-semibold">Document Name</th>
            <th class="px-6 py-4 text-left font-semibold">Campaign</th>
            <th class="px-6 py-4 text-left font-semibold">Description</th>
            <th class="px-6 py-4 text-center font-semibold">Link</th>
          </tr>
        </thead>
        <tbody id="sopTable" class="divide-y divide-gray-200 dark:divide-border-dark bg-white dark:bg-card-dark text-gray-700 dark:text-gray-300">
          <tr>
            <td colspan="5" class="text-center py-6 text-gray-500 dark:text-gray-400">Loading SOP data...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- === TOOLS SECTION === -->
<div id="tools" class="tab-content hidden">
  <!-- Search + Add New -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0 mt-2">
    <div class="relative w-full md:w-1/3">
      <input type="text" id="toolsSearch" onkeyup="handleToolsSearch()"
        placeholder="Search by tool name, campaign, or description..."
        class="w-full p-3 pl-10 border border-gray-300 rounded-full focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-card-dark dark:border-border-dark dark:text-text-dark transition shadow-md">
      <span
        class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl">search</span>
    </div>

    <button id="newToolBtn"
      class="inline-flex items-center bg-brand-accent hover:bg-brand-dark text-bg-dark px-6 py-3 rounded-full shadow-lg font-bold transition duration-300 transform hover:scale-[1.03] text-lg">
      <i class="fas fa-tools mr-3"></i>New Tool Entry
    </button>
  </div>

  <!-- Table Container -->
  <div
    class="relative mt-6 bg-white dark:bg-card-dark rounded-2xl shadow-2xl shadow-gray-200/50 dark:shadow-xl dark:shadow-black/50 overflow-hidden transition-colors duration-500 border border-gray-100 dark:border-border-dark">

    <!-- Loading Spinner -->
    <div id="toolsLoadingSpinner"
      class="hidden absolute inset-0 bg-white/90 dark:bg-card-dark/90 backdrop-blur-sm flex justify-center items-center z-40 transition-opacity duration-300">
      <div class="flex flex-col items-center">
        <i class="fas fa-sync-alt fa-3x text-brand-accent animate-spin-slow"></i>
        <p id="toolsLoadingText" class="mt-3 text-lg text-gray-700 dark:text-text-dark font-medium">Loading Tools data...</p>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900 dark:bg-border-dark text-white dark:text-text-dark uppercase tracking-wider">
          <tr>
            <th class="px-6 py-4 text-left font-semibold">ID</th>
            <th class="px-6 py-4 text-left font-semibold">Tool Name</th>
            <th class="px-6 py-4 text-left font-semibold">Campaign</th>
            <th class="px-6 py-4 text-left font-semibold">Description</th>
            <th class="px-6 py-4 text-center font-semibold">URL</th>
            <th class="px-6 py-4 text-center font-semibold">Work Instruction</th>
          </tr>
        </thead>
        <tbody id="toolsTable" class="divide-y divide-gray-200 dark:divide-border-dark bg-white dark:bg-card-dark text-gray-700 dark:text-gray-300">
          <tr>
            <td colspan="6" class="text-center py-6 text-gray-500 dark:text-gray-400">Loading Tools data...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

        


      
    </main>
  </div>
    


  <div id="sopModal" class="modal hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-center justify-center opacity-0 scale-95" role="dialog" aria-modal="true" aria-labelledby="sopModalTitle">
      <div class="bg-white dark:bg-card-dark rounded-xl shadow-3xl w-full max-w-2xl transform transition-all p-6">
          <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-border-dark">
              <h3 id="sopModalTitle" class="text-2xl font-extrabold text-text-light dark:text-text-dark">New SOP Document Entry</h3>
              <button id="sopCloseBtn" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-text-dark dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-border-dark transition">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          <form id="sopForm" onsubmit="submitNewSOP(event)">
              <div class="space-y-4">
                  <div>
                      <label for="sopDocumentName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Document Name</label>
                      <input type="text" id="sopDocumentName" name="documentName" required 
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
                  </div>
                  <div>
                      <label for="sopCampaign" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Campaign</label>
                      <input type="text" id="sopCampaign" name="campaign" required
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
                  </div>
                  <div>
                      <label for="sopDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                      <textarea id="sopDescription" name="description" rows="3" 
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
                  </div>
                  <div>
                      <label for="sopDriveLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Google Drive Link (URL)</label>
                      <input type="url" id="sopDriveLink" name="driveLink" required
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition" placeholder="e.g., https://drive.google.com/...">
                  </div>
              </div>
              <div class="mt-6 flex justify-end">
                  <button type="submit" 
                      class="inline-flex items-center bg-google-blue hover:bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg font-bold transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fas fa-save mr-2"></i> Save SOP Document
                  </button>
              </div>
          </form>
      </div>
  </div>

  <div id="toolModal" class="modal hidden fixed inset-0 z-[100] bg-black bg-opacity-50 flex items-center justify-center opacity-0 scale-95" role="dialog" aria-modal="true" aria-labelledby="toolModalTitle">
      <div class="bg-white dark:bg-card-dark rounded-xl shadow-3xl w-full max-w-2xl transform transition-all p-6">
          <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-border-dark">
              <h3 id="toolModalTitle" class="text-2xl font-extrabold text-text-light dark:text-text-dark">New Tool Entry</h3>
              <button id="toolCloseBtn" class="p-2 rounded-full text-gray-500 hover:text-gray-800 dark:hover:text-text-dark dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-border-dark transition">
                  <i class="fas fa-times"></i>
              </button>
          </div>
          <form id="toolForm" onsubmit="submitNewTool(event)">
              <div class="space-y-4">
                  <div>
                      <label for="toolName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tool Name</label>
                      <input type="text" id="toolName" name="toolName" required
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
                  </div>
                  <div>
                      <label for="toolCampaign" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Campaign</label>
                      <input type="text" id="toolCampaign" name="campaign" required
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition">
                  </div>
                  <div>
                      <label for="toolDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                      <textarea id="toolDescription" name="description" rows="3" 
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition"></textarea>
                  </div>
                  <div>
                      <label for="toolUrl" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tool URL</label>
                      <input type="url" id="toolUrl" name="url" required
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition" placeholder="e.g., https://app.tool.com">
                  </div>
                  <div>
                      <label for="toolWiLink" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Work Instruction Link (Optional Drive URL)</label>
                      <input type="url" id="toolWiLink" name="wiLink"
                          class="w-full p-3 border border-gray-300 dark:border-border-dark rounded-lg dark:bg-bg-dark dark:text-text-dark focus:ring-brand-accent focus:border-brand-accent transition" placeholder="e.g., https://drive.google.com/...">
                  </div>
              </div>
              <div class="mt-6 flex justify-end">
                  <button type="submit" 
                      class="inline-flex items-center bg-google-blue hover:bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg font-bold transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="fas fa-save mr-2"></i> Save Tool Entry
                  </button>
              </div>
          </form>
      </div>
  </div>


  <script>
    /* ------------------ GLOBAL CONFIG & STATE ------------------ */
    const SOP_TOOLS_API_URL = "https://script.google.com/macros/s/AKfycbwn0GPogd4Cy3TiEPR462FId4nP1DTy2r8Aciqxp389JS6lopKgV5j9u1My_g1YyE7t/exec"; 

    let allSOPSessions = [];
    let allToolsSessions = [];


    /* ------------------ NAVIGATION & UI FUNCTIONS (UNCHANGED) ------------------ */

    function setTabTitle(title) {
        document.getElementById('mainTitleContainer').textContent = title;
    }

    function showTab(tabId, event) {
        if (event) {
            event.preventDefault();
        }

        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('tab-active');
            item.querySelector('.material-symbols-outlined').classList.remove('text-google-blue');
        });

        const activeTab = document.getElementById(tabId);
        if (activeTab) {
            activeTab.classList.remove('hidden');

            const activeNavItem = document.querySelector(`.nav-item[onclick*="showTab('${tabId}'"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('tab-active');
                setTabTitle(activeNavItem.dataset.tabTitle);
            } else {
                 setTabTitle(tabId.toUpperCase());
            }

            if (window.innerWidth < 1024) {
                closeDrawer();
            }
        }
        
        if (tabId === 'sop' && allSOPSessions.length === 0) {
            loadSOP();
        }
        if (tabId === 'tools' && allToolsSessions.length === 0) {
            loadTools();
        }
    }

    // Drawer functionality
    const drawer = document.getElementById('drawer');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menuBtn');
    const closeDrawerBtn = document.getElementById('closeDrawer');

    function openDrawer() {
        drawer.classList.add('drawer-open');
        overlay.classList.remove('hidden');
    }

    function closeDrawer() {
        drawer.classList.remove('drawer-open');
        overlay.classList.add('hidden');
    }

    menuBtn.addEventListener('click', openDrawer);
    closeDrawerBtn.addEventListener('click', closeDrawer);
    overlay.addEventListener('click', closeDrawer);

    // Dark Mode Toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    function updateThemeIcon(isDark) {
        themeToggle.innerHTML = isDark 
            ? '<span class="material-symbols-outlined text-xl">light_mode</span>' 
            : '<span class="material-symbols-outlined text-xl">dark_mode</span>';
    }

    function toggleTheme() {
        const isDark = document.body.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon(isDark);
    }

    themeToggle.addEventListener('click', toggleTheme);

    // Initialize theme
    const storedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialDark = storedTheme === 'dark' || (storedTheme === null && prefersDark);
    if (initialDark) {
        document.body.classList.add('dark');
    }
    updateThemeIcon(initialDark);
    
    // SOP & Tools Data Loading/Rendering/Searching functions (unchanged for brevity)
    
    function showSopLoading(text = 'Loading SOP data...') {
        const spinner = document.getElementById('sopLoadingSpinner');
        const loadingText = document.getElementById('sopLoadingText');
        if (spinner && loadingText) {
             loadingText.textContent = text;
             spinner.classList.remove('hidden');
             setTimeout(() => spinner.style.opacity = '1', 10);
        }
    }

    function hideSopLoading() {
        const spinner = document.getElementById('sopLoadingSpinner');
        if (spinner) {
            spinner.style.opacity = '0';
            setTimeout(() => spinner.classList.add('hidden'), 300);
        }
    }

    function renderSOPTable(sessionsToRender) {
        const table = document.getElementById("sopTable");
        table.innerHTML = ""; 

        if (!Array.isArray(sessionsToRender) || sessionsToRender.length === 0) {
            table.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500 dark:text-gray-400">No SOP documents match your criteria.</td></tr>`;
            return;
        }

        sessionsToRender.forEach(session => {
            const linkUrl = session.driveLink && session.driveLink.length > 5 && session.driveLink !== '#' ? session.driveLink : "#"; 
            const descriptionText = session.description || "No description provided.";
            
            table.innerHTML += `
                <tr class="hover:bg-gray-50 dark:hover:bg-card-dark transition duration-150">
                    <td class="px-4 py-3">${session.id || "N/A"}</td>
                    <td class="px-4 py-3 font-medium text-text-light dark:text-text-dark">${session.documentName || "N/A"}</td>
                    <td class="px-4 py-3">${session.campaign || "N/A"}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-400">${descriptionText}</td>
                    <td class="px-4 py-3 text-center">
                        <a href="${linkUrl}" target="_blank" 
                            class="${linkUrl === '#' ? 'text-gray-400 cursor-default' : 'text-google-blue hover:text-blue-600'}" 
                            title="${linkUrl === '#' ? 'Document link not available' : 'Open SOP Document'}">
                            <i class="fab fa-google-drive fa-lg"></i>
                        </a>
                    </td>
                </tr>`;
        });
    }

    function handleSOPSearch() {
        const query = document.getElementById('sopSearch').value.toLowerCase().trim();
        
        if (!query) {
            renderSOPTable(allSOPSessions); 
            return;
        }

        const filteredSessions = allSOPSessions.filter(session => {
            return (session.documentName && session.documentName.toLowerCase().includes(query)) ||
                   (session.description && session.description.toLowerCase().includes(query)) ||
                   (session.campaign && session.campaign.toLowerCase().includes(query)) ||
                   (session.id && String(session.id).toLowerCase().includes(query));
        });

        renderSOPTable(filteredSessions);
    }

    async function loadSOP() {
        showSopLoading();
        
        try {
            const fetchUrl = SOP_TOOLS_API_URL + '?action=getSOP';
            const res = await fetch(fetchUrl);

            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}. Check SOP/Tools Apps Script URL.`);
            }
            
            const apiData = await res.json();
            
            if (apiData.error) {
                throw new Error(apiData.error);
            }

            allSOPSessions = Array.isArray(apiData) ? apiData : apiData.data || [];
            
            renderSOPTable(allSOPSessions);

        } catch (error) {
            console.error("Error loading SOP records:", error);
            const errorMessage = `Failed to load SOP data. Check the SOP_TOOLS_API_URL and Apps Script deployment. (Error: ${error.message})`;
            document.getElementById("sopTable").innerHTML = `<tr><td colspan="5" class="text-center py-6 text-danger font-semibold dark:text-red-400">${errorMessage}</td></tr>`;
        }
        hideSopLoading();
    }
    
    function showToolsLoading(text = 'Loading Tools data...') {
        const spinner = document.getElementById('toolsLoadingSpinner');
        const loadingText = document.getElementById('toolsLoadingText');
        if (spinner && loadingText) {
             loadingText.textContent = text;
             spinner.classList.remove('hidden');
             setTimeout(() => spinner.style.opacity = '1', 10);
        }
    }

    function hideToolsLoading() {
        const spinner = document.getElementById('toolsLoadingSpinner');
        if (spinner) {
            spinner.style.opacity = '0';
            setTimeout(() => spinner.classList.add('hidden'), 300);
        }
    }

    function renderToolsTable(sessionsToRender) {
        const table = document.getElementById("toolsTable");
        table.innerHTML = ""; 

        if (!Array.isArray(sessionsToRender) || sessionsToRender.length === 0) {
            table.innerHTML = `<tr><td colspan="6" class="text-center py-6 text-gray-500 dark:text-gray-400">No Tools records match your criteria.</td></tr>`;
            return;
        }

        sessionsToRender.forEach(session => {
            const url = session.url && session.url.length > 5 && session.url !== '#' ? session.url : "#"; 
            const wiLink = session.wiLink && session.wiLink.length > 5 && session.wiLink !== '#' ? session.wiLink : "#"; 
            const descriptionText = session.description || "No description provided.";
            
            table.innerHTML += `
                <tr class="hover:bg-gray-50 dark:hover:bg-card-dark transition duration-150">
                    <td class="px-4 py-3">${session.id || "N/A"}</td>
                    <td class="px-4 py-3 font-medium text-text-light dark:text-text-dark">${session.toolName || "N/A"}</td>
                    <td class="px-4 py-3">${session.campaign || "N/A"}</td>
                    <td class="px-4 py-3 text-gray-600 dark:text-gray-400">${descriptionText}</td>
                    <td class="px-4 py-3 text-center">
                        <a href="${url}" target="_blank" 
                            class="${url === '#' ? 'text-gray-400 cursor-default' : 'text-google-blue hover:text-blue-600'}" 
                            title="${url === '#' ? 'URL not available' : 'Open Tool Website'}">
                            <i class="fas fa-external-link-alt fa-lg"></i>
                        </a>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <a href="${wiLink}" target="_blank" 
                            class="${wiLink === '#' ? 'text-gray-400 cursor-default' : 'text-google-green hover:text-green-600'}" 
                            title="${wiLink === '#' ? 'Work Instruction not available' : 'Open Work Instruction'}">
                            <i class="fab fa-google-drive fa-lg"></i>
                        </a>
                    </td>
                </tr>`;
        });
    }

    function handleToolsSearch() {
        const query = document.getElementById('toolsSearch').value.toLowerCase().trim();
        
        if (!query) {
            renderToolsTable(allToolsSessions); 
            return;
        }

        const filteredSessions = allToolsSessions.filter(session => {
            return (session.toolName && session.toolName.toLowerCase().includes(query)) ||
                   (session.description && session.description.toLowerCase().includes(query)) ||
                   (session.campaign && session.campaign.toLowerCase().includes(query)) ||
                   (session.id && String(session.id).toLowerCase().includes(query));
        });

        renderToolsTable(filteredSessions);
    }

    async function loadTools() {
        showToolsLoading();
        
        try {
            const fetchUrl = SOP_TOOLS_API_URL + '?action=getTools';
            const res = await fetch(fetchUrl);

            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}. Check SOP/Tools Apps Script URL.`);
            }
            
            const apiData = await res.json();
            
            if (apiData.error) {
                throw new Error(apiData.error);
            }

            allToolsSessions = Array.isArray(apiData) ? apiData : apiData.data || [];
            
            renderToolsTable(allToolsSessions);

        } catch (error) {
            console.error("Error loading Tools records:", error);
            const errorMessage = `Failed to load Tools data. Check the SOP_TOOLS_API_URL and Apps Script deployment. (Error: ${error.message})`;
            document.getElementById("toolsTable").innerHTML = `<tr><td colspan="6" class="text-center py-6 text-danger font-semibold dark:text-red-400">${errorMessage}</td></tr>`;
        }
        hideToolsLoading();
    }
    
    
    /* ------------------ NEW MODAL LOGIC ------------------ */

    const sopModal = document.getElementById('sopModal');
    const toolModal = document.getElementById('toolModal');

    function openModal(modal) {
        modal.classList.remove('hidden');
        // Force reflow to ensure transition runs
        void modal.offsetWidth; 
        modal.classList.add('opacity-100', 'scale-100');
    }

    function closeModal(modal) {
        modal.classList.remove('opacity-100', 'scale-100');
        modal.classList.add('opacity-0', 'scale-95');
        // Hide after transition duration (300ms)
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // New Entry Button Handlers: Open the correct modal
    document.getElementById('newSOPBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openModal(sopModal);
    });

    document.getElementById('newToolBtn').addEventListener('click', (e) => {
        e.preventDefault();
        openModal(toolModal);
    });

    // Close Modal Listeners (for close button and overlay click)
    sopModal.addEventListener('click', (e) => {
        // Check if the click is on the modal backdrop or the close button
        if (e.target === sopModal || e.target.closest('#sopCloseBtn')) {
            closeModal(sopModal);
        }
    });

    toolModal.addEventListener('click', (e) => {
        // Check if the click is on the modal backdrop or the close button
        if (e.target === toolModal || e.target.closest('#toolCloseBtn')) {
            closeModal(toolModal);
        }
    });

    // Placeholder Submission Logic
    function submitNewSOP(e) {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;

        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';

        // *** PLACEHOLDER for API CALL (Replace with actual fetch to SOP_TOOLS_API_URL) ***
        setTimeout(() => {
            alert('SOP Entry submitted successfully! (Simulation)');
            
            // In a real scenario, you would call loadSOP() here to refresh the table.
            // loadSOP(); 
            
            closeModal(sopModal);
            
            // Reset form and button
            form.reset();
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }, 1500);
    }
    
    function submitNewTool(e) {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';

        // *** PLACEHOLDER for API CALL (Replace with actual fetch to SOP_TOOLS_API_URL) ***
        setTimeout(() => {
            alert('Tool Entry submitted successfully! (Simulation)');
            
            // In a real scenario, you would call loadTools() here to refresh the table.
            // loadTools(); 
            
            closeModal(toolModal);
            
            // Reset form and button
            form.reset();
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }, 1500);
    }

    // Add event listeners for form submission
    document.getElementById('sopForm').addEventListener('submit', submitNewSOP);
    document.getElementById('toolForm').addEventListener('submit', submitNewTool);
    
    
    /* ------------------ INIT ------------------ */
    document.addEventListener('DOMContentLoaded', () => {
      // Show the initial tab (SOP Documents) and set the initial header title
      showTab('sop');
    });
  </script>
</body>
</html>