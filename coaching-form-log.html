<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Minds BPO - Coaching</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand-accent': '#CBEB33',
                        'brand-dark': '#B5D12F',
                        'bg-dark': '#0f172a',
                        'text-dark': '#f1f5f9',
                        'bg-light': '#f8fafc',
                        'text-light': '#1e293b',
                        'card-dark': '#1e293b',
                        'border-dark': '#334155',
                        'danger': '#ef4444',
                        'danger-dark': '#dc2626'
                    }
                }
            }
        };
    </script>

    <style>
        .animate-spin-slow {
            animation: spin 2.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* NEW: Styles for Print View Modal */
        /* Hides non-essential elements when printing */
        @media print {
            body > *:not(#modalBg):not(#deleteConfirmModal) {
                display: none !important;
            }
            /* Only show the view modal content */
            #modalBg {
                display: flex !important;
                position: static !important;
                background: none !important;
                width: 100% !important;
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
            }
            #modalContent {
                box-shadow: none !important;
                border: none !important;
                transform: none !important;
                opacity: 1 !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 3rem !important; /* Document padding */
                min-height: 100vh;
            }
            /* Hide close and print buttons in print view */
            #modalContent button, #modalContent .modal-actions {
                display: none !important;
            }
            /* Ensure the content is black on white paper */
            #modalContent, #modalContent * {
                color: #000 !important;
                background-color: white !important;
                filter: none !important;
            }
            /* Style the 'view as document' elements for printing */
            .view-field {
                border-bottom: 1px solid #ddd !important;
                padding-bottom: 0.5rem !important;
                margin-bottom: 1rem !important;
            }
            .view-title {
                font-weight: bold !important;
                color: #4b5563 !important;
                text-transform: uppercase;
                font-size: 0.875rem;
            }
            .view-value {
                font-size: 1rem !important;
                padding-top: 0.25rem !important;
            }
        }
    </style>
</head>

<body
    class="min-h-screen bg-bg-light text-text-light dark:bg-bg-dark dark:text-text-dark transition-colors duration-500 font-sans">

    <header
        class="flex justify-between items-center px-8 py-4 bg-white dark:bg-card-dark shadow-lg w-full fixed top-0 left-0 z-20 transition-all duration-500 border-b border-gray-100 dark:border-border-dark">
        <h1 class="text-3xl font-extrabold text-text-light dark:text-text-dark transition-colors duration-500">
            <span class="text-brand-accent">Digital</span> Coaching
        </h1>
        <button id="themeToggle"
            class="p-2 rounded-full text-text-light dark:text-text-dark bg-gray-100 dark:bg-border-dark hover:bg-brand-accent hover:text-bg-dark transition-all duration-300 transform hover:scale-105"
            aria-label="Toggle Dark Mode">
        </button>
    </header>

    <div class="max-w-7xl mx-auto p-4 md:p-8 mt-24 space-y-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
            <h2 class="text-3xl font-extrabold text-text-light dark:text-text-dark">Coaching Sessions</h2>
            <button onclick="openModal()"
                class="inline-flex items-center bg-brand-accent hover:bg-brand-dark text-bg-dark px-6 py-3 rounded-full shadow-lg font-bold transition duration-300 transform hover:scale-[1.03] text-lg">
                <i class="fas fa-plus-circle mr-3"></i>New Session
            </button>
        </div>

        <div
            class="bg-white dark:bg-card-dark rounded-2xl shadow-2xl shadow-gray-200/50 dark:shadow-xl dark:shadow-black/50 overflow-hidden transition-colors duration-500 border border-gray-100 dark:border-border-dark">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-100 dark:bg-border-dark text-left">
                        <tr>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Date</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Coach</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Employee</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Focus Area</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Signed Form</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider px-6 py-4">Acknowledge</th>
                            <th class="font-semibold text-gray-600 dark:text-text-dark uppercase tracking-wider text-center px-6 py-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTable" class="divide-y divide-gray-200 dark:divide-border-dark">
                        <tr class="text-center">
                            <td colspan="7" class="p-8 text-gray-500 dark:text-gray-400">
                                Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalBg" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50 transition-opacity duration-300">
        <div
            class="bg-white dark:bg-card-dark rounded-xl shadow-3xl w-full max-w-4xl p-8 relative transition-all duration-500 transform scale-95 opacity-0" id="modalContent">
            
            <button id="printButton" onclick="printCoachingForm()" 
                class="absolute top-4 right-14 p-2 rounded-full text-gray-400 hover:text-brand-accent transition hidden" 
                title="Print Form">
                <i class="fas fa-print fa-xl"></i>
            </button>
            
            <h3 id="modalTitle" class="text-3xl font-extrabold mb-6 text-brand-accent">Add Coaching Session</h3>
            <button onclick="closeModal()" class="absolute top-4 right-4 p-2 rounded-full text-gray-400 hover:text-brand-accent transition">
                <i class="fas fa-times fa-xl"></i>
            </button>

            <form id="coachingForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" name="id" />

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Name</label>
                    <input type="text" name="employee"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Coach Name</label>
                    <input type="text" name="coach"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Employee Number</label>
                    <input type="text" name="employeenumber"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Session Date</label>
                    <input type="date" name="date"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Performance/Behavior Observed</label>
                    <textarea name="performance" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition"></textarea>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Coaching Provided</label>
                    <textarea name="coachingprovided" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition"></textarea>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Agreed Action Plan</label>
                    <textarea name="actionplan" rows="3"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Signed Form Link (Google Drive URL)</label>
                    <input type="url" name="SignedForm" placeholder="Optional Google Drive link..."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Acknowledge</label>
                    <select name="acknowledge"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-accent focus:border-brand-accent dark:bg-bg-dark dark:border-border-dark dark:text-text-dark transition">
                        <option value="Pending" selected>Pending</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>

                <div class="md:col-span-2 flex justify-end space-x-4 pt-6 border-t border-gray-200 dark:border-border-dark modal-actions">
                    <button type="button" onclick="closeModal()"
                        class="py-3 px-6 border border-gray-300 dark:border-border-dark rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-bg-dark transition font-semibold">Cancel</button>
                    <button type="submit"
                        class="py-3 px-6 bg-brand-accent hover:bg-brand-dark text-bg-dark font-bold rounded-full shadow-md transition transform hover:scale-[1.02]">Save Session</button>
                </div>
            </form>

            <div id="modalContentPrintable" class="hidden">
                <div class="border border-gray-300 dark:border-border-dark rounded-lg p-6 space-y-4 bg-white dark:bg-card-dark text-text-light dark:text-text-dark">
                    <div class="text-center pb-4 border-b border-gray-200 dark:border-border-dark">
                        <h4 class="text-2xl font-extrabold text-brand-accent">Coaching Session Form</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="viewSessionID"></p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="view-field">
                            <p class="view-title text-sm">Date</p>
                            <p class="view-value font-semibold" data-view="date"></p>
                        </div>
                        <div class="view-field">
                            <p class="view-title text-sm">Coach Name</p>
                            <p class="view-value font-semibold" data-view="coach"></p>
                        </div>
                        <div class="view-field">
                            <p class="view-title text-sm">Employee Name</p>
                            <p class="view-value font-semibold" data-view="employee"></p>
                        </div>
                        <div class="view-field">
                            <p class="view-title text-sm">Employee Number</p>
                            <p class="view-value" data-view="employeenumber"></p>
                        </div>
                        <div class="view-field col-span-1 md:col-span-2">
                            <p class="view-title text-sm">Signed Form Link</p>
                            <p class="view-value" id="viewSignedFormLink"></p>
                        </div>
                        <div class="view-field">
                            <p class="view-title text-sm">Acknowledgement</p>
                            <p class="view-value" data-view="acknowledge"></p>
                        </div>
                    </div>

                    <div class="view-field">
                        <p class="view-title mt-4">Performance/Behavior Observed</p>
                        <p class="view-value whitespace-pre-wrap" data-view="performance"></p>
                    </div>
                    <div class="view-field">
                        <p class="view-title mt-4">Coaching Provided</p>
                        <p class="view-value whitespace-pre-wrap" data-view="coachingprovided"></p>
                    </div>
                    <div class="view-field">
                        <p class="view-title mt-4">Agreed Action Plan</p>
                        <p class="view-value whitespace-pre-wrap" data-view="actionplan"></p>
                    </div>
                    
                    <div class="pt-6 border-t border-dashed border-gray-300 dark:border-border-dark">
                        <p class="text-xs text-gray-500 dark:text-gray-400">Digital signature acknowledgment on file.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex justify-center items-center z-50 transition-opacity duration-300">
        <div id="deleteModalContent"
            class="bg-white dark:bg-card-dark rounded-xl shadow-3xl w-full max-w-sm p-6 relative transition-all duration-500 transform scale-95 opacity-0 text-center">
            
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/50">
                <i class="fas fa-trash-alt text-danger fa-lg"></i>
            </div>
            
            <h3 class="text-xl font-bold mt-3 text-text-light dark:text-text-dark">Confirm Deletion</h3>
            <p id="deleteMessage" class="text-sm text-gray-500 dark:text-gray-400 mt-2">Are you absolutely sure you want to delete this session? This action cannot be undone.</p>
            
            <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="confirmDeleteButton"
                    class="inline-flex w-full justify-center rounded-full border border-transparent bg-danger hover:bg-danger-dark px-4 py-2 text-base font-semibold text-white shadow-sm transition sm:ml-3 sm:w-auto sm:text-sm transform hover:scale-[1.02]">
                    Delete
                </button>
                <button type="button" onclick="closeDeleteModal()"
                    class="mt-3 inline-flex w-full justify-center rounded-full border border-gray-300 dark:border-border-dark bg-white dark:bg-card-dark px-4 py-2 text-base font-semibold text-gray-700 dark:text-gray-300 shadow-sm hover:bg-gray-50 dark:hover:bg-bg-dark transition sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <div id="loadingModal"
        class="hidden fixed inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center z-50">
        <div class="relative flex items-center justify-center">
            <div class="w-16 h-16 border-4 border-gray-300 dark:border-border-dark border-t-brand-accent rounded-full animate-spin"></div>
            <div class="absolute w-10 h-10 border-4 border-gray-200 dark:border-gray-700 border-b-brand-dark rounded-full animate-spin-slow"></div>
        </div>
        <p id="loadingText" class="mt-4 text-brand-accent text-lg font-semibold">Loading...</p>
    </div>

    <script>
        feather.replace();

        const toggleBtn = document.getElementById('themeToggle');
        const body = document.body;
        const form = document.getElementById("coachingForm");
        const modalBg = document.getElementById('modalBg');
        const modalContent = document.getElementById('modalContent');
        const modalPrintable = document.getElementById('modalContentPrintable');
        const printButton = document.getElementById('printButton');
        const deleteModal = document.getElementById('deleteConfirmModal');
        const deleteModalContent = document.getElementById('deleteModalContent');
        const confirmDeleteButton = document.getElementById('confirmDeleteButton');
        const API_URL = "https://script.google.com/macros/s/AKfycbyn9CG1Lk3S5bXtfEEbvH5H-8GfBBOvY4OGSJPyIM5RZSDBCOf4fwkXVvnKjzZGvqUL/exec";
        let sessionIdToDelete = null;

        /* ------------------ THEME TOGGLE FIX (No Change) ------------------ */

        function setTheme(isDark) {
            if (isDark) {
                body.classList.add("dark");
                localStorage.setItem("theme", "dark");
                toggleBtn.innerHTML = feather.icons.sun.toSvg();
            } else {
                body.classList.remove("dark");
                localStorage.setItem("theme", "light");
                toggleBtn.innerHTML = feather.icons.moon.toSvg();
            }
        }

        if (localStorage.getItem("theme") === "dark" || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setTheme(true);
        } else {
            setTheme(false);
        }

        toggleBtn.addEventListener('click', () => {
            const isDark = body.classList.contains('dark');
            setTheme(!isDark);
        });

        /* ------------------ LOADING (No Change) ------------------ */
        function showLoading(message = "Loading...") {
            document.getElementById('loadingText').innerText = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        /* ------------------ MODAL FIX (Core Logic) ------------------ */
        function openModal(editing = false, isView = false) {
            // 1. Configure the modal structure
            form.classList.toggle('hidden', isView);
            modalPrintable.classList.toggle('hidden', !isView);
            printButton.classList.toggle('hidden', !isView);
            
            // Re-enable form elements for edit/add mode
            if (!isView) {
                [...form.elements].forEach(el => el.disabled = false);
                form.querySelector('button[type="submit"]').classList.remove('hidden');
            }
            
            document.getElementById("modalTitle").innerText = isView
                ? "View Coaching Session"
                : editing
                ? "Edit Coaching Session"
                : "Add Coaching Session";

            // 2. Open the modal container
            modalBg.classList.remove('hidden');
            setTimeout(() => {
                modalBg.classList.add('opacity-100');
                modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeModal() {
            modalBg.classList.remove('opacity-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modalBg.classList.add('hidden');
                form.reset();
                delete form.dataset.editId;
                // Ensure form elements are ready for next use
                [...form.elements].forEach(el => el.disabled = false);
                form.querySelector('button[type="submit"]').classList.remove('hidden');
            }, 300);
        }

        /* ------------------ DELETE MODAL FUNCTIONS (No Change) ------------------ */
        function openDeleteModal(id) {
            sessionIdToDelete = id;
            deleteModal.classList.remove('hidden');
            setTimeout(() => {
                deleteModal.classList.add('opacity-100');
                deleteModalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('opacity-100');
            deleteModalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                deleteModal.classList.add('hidden');
                sessionIdToDelete = null;
            }, 300);
        }
        
        confirmDeleteButton.addEventListener('click', () => {
            if (sessionIdToDelete !== null) {
                executeDeleteSession(sessionIdToDelete); 
            }
            closeDeleteModal();
        });


        /* ------------------ LOAD SESSIONS (Updated with SignedForm link handling) ------------------ */
        async function loadSessions() {
            showLoading("Fetching coaching sessions...");
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Network response was not ok');
                const sessions = await res.json();
                const table = document.getElementById("sessionsTable");
                table.innerHTML = "";

                if (sessions.length === 0) {
                    table.innerHTML = `
                        <tr class="text-center">
                            <td colspan="7" class="p-8 text-gray-500 dark:text-gray-400">
                                No coaching sessions found. Click 'New Session' to add one.
                            </td>
                        </tr>
                    `;
                } else {
                    sessions.forEach(session => {
                        const acknowledgeStatus = session.acknowledge || "Pending";
                        const signedFormUrl = session.SignedForm || ""; 

                        let ackClass = "bg-gray-200 text-gray-700";
                        if (acknowledgeStatus === "Yes") {
                            ackClass = "bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";
                        } else if (acknowledgeStatus === "No") {
                            ackClass = "bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300";
                        }

                        // Signed Form Link status display
                        const signedFormDisplay = signedFormUrl
                            ? `<a href="${signedFormUrl}" target="_blank" class="text-blue-500 hover:text-blue-400 font-semibold transition">View Link <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>`
                            : `<span class="text-gray-500 dark:text-gray-400">N/A</span>`;
                        
                        table.innerHTML += `
                            <tr class="text-gray-700 dark:text-gray-300 border-b dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-800/50 transition duration-150">
                                <td class="px-6 py-4 whitespace-nowrap">${session.date || session.Date || 'N/A'}</td>
                                <td class="px-6 py-4">${session.coach || session.Coach || 'N/A'}</td>
                                <td class="px-6 py-4 font-medium">${session.employee || session.Employee || 'N/A'}</td>
                                <td class="px-6 py-4 max-w-xs truncate">${session.performance || session.Performance || 'N/A'}</td>
                                <td class="px-6 py-4">${signedFormDisplay}</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${ackClass}">
                                        ${acknowledgeStatus}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center space-x-2 whitespace-nowrap">
                                    <button class="text-blue-500 hover:text-brand-accent transition text-sm font-semibold" onclick='viewSession(${JSON.stringify(session)})'>View</button>
                                    <button class="text-green-500 hover:text-brand-accent transition text-sm font-semibold" onclick='editSession(${JSON.stringify(session)})'>Edit</button>
                                    <button class="text-red-500 hover:text-brand-accent transition text-sm font-semibold" onclick='openDeleteModal(${session.ID || session.id})'>Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                }

            } catch (error) {
                console.error("Failed to load sessions:", error);
                const table = document.getElementById("sessionsTable");
                table.innerHTML = `
                    <tr class="text-center">
                        <td colspan="7" class="p-8 text-red-500 dark:text-red-400">
                            Failed to load data. Check the API URL.
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }

        /* ------------------ VIEW SESSION (Fixed and Modernized) ------------------ */
        function viewSession(session) {
            // 1. Set modal to View Mode
            openModal(false, true); // (editing=false, isView=true)

            // 2. Populate Printable Document Fields
            document.getElementById("modalTitle").innerText = `Session Details - ${session.employee || session.Employee}`;
            document.getElementById("viewSessionID").innerText = `ID: ${session.ID || session.id}`;

            // List of fields to populate
            const viewFields = [
                'date', 'coach', 'employee', 'employeenumber', 
                'performance', 'coachingprovided', 'actionplan'
            ];
            
            viewFields.forEach(key => {
                const el = document.querySelector(`#modalContentPrintable [data-view="${key}"]`);
                // Use default session keys (lowercase) and fallback to uppercase keys from sheet
                const value = session[key] || session[key.charAt(0).toUpperCase() + key.slice(1)] || 'N/A';
                if (el) {
                    el.innerText = value;
                }
            });
            
            // Special handling for Acknowledge
            const ackEl = document.querySelector(`#modalContentPrintable [data-view="acknowledge"]`);
            if (ackEl) {
                const status = session.acknowledge || 'Pending';
                ackEl.innerHTML = `<span class="font-bold ${status === 'Yes' ? 'text-green-600' : status === 'No' ? 'text-red-600' : 'text-gray-500'}">${status}</span>`;
            }

            // Special handling for Signed Form Link
            const signedFormUrl = session.SignedForm || '';
            const signedLinkEl = document.getElementById("viewSignedFormLink");

            if (signedFormUrl) {
                signedLinkEl.innerHTML = `<a href="${signedFormUrl}" target="_blank" class="text-blue-600 hover:text-blue-500 font-medium break-all">${signedFormUrl}</a>`;
            } else {
                signedLinkEl.innerHTML = `<span class="text-gray-500 italic">No signed form link provided.</span>`;
            }

            // 3. Disable all form inputs (as a fallback, but the form is hidden)
            [...form.elements].forEach(el => el.disabled = true);
        }

        /* ------------------ EDIT SESSION (Fixed and Updated with SignedForm) ------------------ */
        function editSession(session) {
            openModal(true, false); // (editing=true, isView=false)

            // Populate form fields including SignedForm
            const fields = ['id', 'employee', 'coach', 'employeenumber', 'date', 'performance', 'coachingprovided', 'actionplan', 'acknowledge', 'SignedForm'];
            fields.forEach(key => {
                const el = form.elements.namedItem(key); 
                // Use session[key] if present, otherwise fallback to sheet-style key
                const value = session[key] || session[key.charAt(0).toUpperCase() + key.slice(1)] || '';
                if (el) el.value = value;
            });

            form.dataset.editId = session.ID || session.id;
        }

        /* ------------------ PRINT FUNCTION (NEW) ------------------ */
        function printCoachingForm() {
            window.print();
        }

        /* ------------------ DELETE SESSION & SAVE/UPDATE (No Change to logic) ------------------ */
        async function executeDeleteSession(id) {
            showLoading("Deleting session...");
            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({ _method: "DELETE", id })
                });
                if (!res.ok) throw new Error('Delete failed');
            } catch (error) {
                console.error("Error deleting session:", error);
                alert("Failed to delete session. Check the console for details.");
            }
            await loadSessions();
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            showLoading(this.dataset.editId ? "Updating session..." : "Saving session...");
            const formData = Object.fromEntries(new FormData(this).entries());

            try {
                if (this.dataset.editId) {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify({ _method: "PUT", id: this.dataset.editId, ...formData })
                    });
                    if (!res.ok) throw new Error('Update failed');
                } else {
                    const res = await fetch(API_URL, {
                        method: "POST",
                        body: JSON.stringify(formData)
                    });
                    if (!res.ok) throw new Error('Save failed');
                }
                closeModal();
                loadSessions();
            } catch (error) {
                console.error("Error saving session:", error);
                hideLoading();
                alert(`Failed to save session: ${error.message}. Check the console for details.`);
            }
        });

        /* ------------------ INIT ------------------ */
        window.onload = loadSessions;
    </script>

</body>

</html>
