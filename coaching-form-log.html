<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Minds BPO - Coaching</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#CBEB33',
            brandlight: '#D9F25A',
            blackpearl: '#04101d',
            pear: '#e5e7eb',
            waterloo: '#565f6f',
            wasabi: '#2c370b',
            primary: '#1f2937',
            secondary: '#4b5563'
          }
        }
      }
    };
  </script>
</head>

<body class="min-h-screen bg-gray-100 text-slate-800 transition-colors duration-300">

  <!-- Header -->
  <header class="flex justify-between items-center p-6 bg-blackpearl dark:bg-primary shadow w-full fixed top-0 left-0 z-20 transition-colors duration-300">
    <h1 class="text-3xl font-extrabold text-brandlight dark:text-brand">Employee Coaching</h1>
    <div class="absolute top-6 right-6">
      <button id="themeToggle" class="p-2 rounded-full text-pear hover:text-brand transition">
        <i data-feather="moon"></i>
      </button>
    </div>
  </header>

  <!-- Container -->
  <div class="max-w-7xl mx-auto p-8 pt-28 space-y-6">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold text-primary dark:text-pear">Past Coaching Sessions</h2>
      <button onclick="openModal()" class="inline-flex items-center bg-brand hover:bg-brandlight text-blackpearl px-6 py-3 rounded-full shadow-lg font-bold transition duration-150 transform hover:scale-[1.02]">
        <i class="fas fa-plus-circle mr-2"></i>Add Coaching Session
      </button>
    </div>

    <!-- Table Card -->
    <div class="bg-white dark:bg-waterloo rounded-xl shadow-2xl p-6 relative transition-colors duration-300">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-blackpearl text-white dark:bg-wasabi">
            <tr>
              <th class="text-left px-4 py-3">Date</th>
              <th class="text-left px-4 py-3">Coach</th>
              <th class="text-left px-4 py-3">Employee</th>
              <th class="text-left px-4 py-3">Focus Area</th>
              <th class="text-left px-4 py-3">Acknowledge</th>
              <th class="text-center px-4 py-3">Actions</th>
            </tr>
          </thead>
          <tbody id="sessionsTable" class="divide-y divide-gray-100 dark:divide-gray-700">
            <!-- Rows loaded dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBg" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white dark:bg-waterloo rounded-lg shadow-xl w-full max-w-3xl p-6 relative transition-colors duration-300">
      <h3 id="modalTitle" class="text-2xl font-bold mb-4 text-primary dark:text-brand">Add Coaching Session</h3>
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
        <i class="fas fa-times fa-lg"></i>
      </button>

      <form id="coachingForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" name="id" />

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Employee Name</label>
          <input type="text" name="employee" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Coach Name</label>
          <input type="text" name="coach" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Employee Number</label>
          <input type="text" name="employeenumber" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Session Date</label>
          <input type="date" name="date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear">
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Performance/Behavior Observed</label>
          <textarea name="performance" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear"></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Coaching Provided</label>
          <textarea name="coachingprovided" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear"></textarea>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Agreed Action Plan</label>
          <textarea name="actionplan" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-pear">Acknowledge</label>
          <select name="acknowledge" class="mt-1 block w-full p-2 border border-gray-300 rounded-md dark:bg-blackpearl dark:border-waterloo dark:text-pear">
            <option value="Pending" selected>Pending</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="md:col-span-2 flex justify-end space-x-3 pt-4 border-t dark:border-waterloo">
          <button type="button" onclick="closeModal()" class="py-2 px-4 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 dark:border-waterloo dark:text-pear">Cancel</button>
          <button type="submit" class="py-2 px-4 bg-brand hover:bg-brandlight text-blackpearl font-semibold rounded-md shadow-md">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading -->
  <div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex flex-col justify-center items-center z-50">
    <div class="relative flex items-center justify-center">
      <div class="w-16 h-16 border-4 border-brand border-t-transparent rounded-full animate-spin"></div>
      <div class="absolute w-10 h-10 border-4 border-brandlight border-b-transparent rounded-full animate-spin-slow"></div>
    </div>
    <p id="loadingText" class="mt-4 text-brand text-lg font-semibold">Loading...</p>
  </div>

  <!-- Custom animation -->
  <style>
    .animate-spin-slow {
      animation: spin 2.5s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>

  <!-- Keep JS logic -->
  <script>
    feather.replace();
    const toggleBtn = document.getElementById('themeToggle');
    toggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      toggleBtn.innerHTML = document.body.classList.contains('dark')
        ? feather.icons.sun.toSvg()
        : feather.icons.moon.toSvg();
    });

    const API_URL = "https://script.google.com/macros/s/AKfycbyn9CG1Lk3S5bXtfEEbvH5H-8GfBBOvY4OGSJPyIM5RZSDBCOf4fwkXVvnKjzZGvqUL/exec";

    function showLoading(message = "Loading...") {
      document.getElementById('loadingText').innerText = message;
      document.getElementById('loadingModal').classList.remove('hidden');
    }
    function hideLoading() { document.getElementById('loadingModal').classList.add('hidden'); }

    const form = document.getElementById("coachingForm");

    function openModal(editing = false) {
      document.getElementById('modalBg').classList.remove('hidden');
      document.getElementById("modalTitle").innerText = editing ? "Edit Coaching Session" : "Add Coaching Session";
    }
    function closeModal() {
      document.getElementById('modalBg').classList.add('hidden');
      form.reset();
      delete form.dataset.editId;
      [...form.elements].forEach(el => el.disabled = false);
      form.querySelector('button[type="submit"]').classList.remove('hidden');
    }

    async function loadSessions() {
      showLoading("Fetching coaching sessions...");
      const res = await fetch(API_URL);
      const sessions = await res.json();
      const table = document.getElementById("sessionsTable");
      table.innerHTML = "";
      sessions.forEach(session => {
        table.innerHTML += `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition duration-150">
            <td class="px-4 py-3">${session.date || session.Date}</td>
            <td class="px-4 py-3">${session.coach || session.Coach}</td>
            <td class="px-4 py-3">${session.employee || session.Employee}</td>
            <td class="px-4 py-3">${session.performance || session.Performance}</td>
            <td class="px-4 py-3">${session.acknowledge || "Pending"}</td>
            <td class="px-4 py-3 text-center space-x-2">
              <button class="text-green-600 hover:underline text-sm" onclick='viewSession(${JSON.stringify(session)})'>View</button>
              <button class="text-blue-600 hover:underline text-sm" onclick='editSession(${JSON.stringify(session)})'>Edit</button>
              <button class="text-red-600 hover:underline text-sm" onclick='deleteSession(${session.ID || session.id})'>Delete</button>
            </td>
          </tr>
        `;
      });
      hideLoading();
    }

    function viewSession(session) {
      openModal(false);
      Object.keys(session).forEach(key => {
        if (form[key]) {
          form[key].value = session[key];
          form[key].disabled = true;
        }
      });
      form.querySelector('button[type="submit"]').classList.add('hidden');
    }

    function editSession(session) {
      openModal(true);
      Object.keys(session).forEach(key => {
        if (form[key]) form[key].value = session[key];
      });
      form.dataset.editId = session.ID || session.id;
    }

    async function deleteSession(id) {
      if (!confirm("Delete this session?")) return;
      showLoading("Deleting session...");
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ _method: "DELETE", id })
      });
      await loadSessions();
      hideLoading();
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      showLoading(this.dataset.editId ? "Updating session..." : "Saving session...");
      const formData = Object.fromEntries(new FormData(this).entries());

      if (this.dataset.editId) {
        await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ _method: "PUT", id: this.dataset.editId, ...formData })
        });
        delete this.dataset.editId;
      } else {
        await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(formData)
        });
      }

      hideLoading();
      closeModal();
      loadSessions();
    });

    window.onload = loadSessions;
  </script>
</body>
</html>
